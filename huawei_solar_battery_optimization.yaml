# Huawei Solar Battery Optimization
# huawei_solar_battery_optimization.yaml
# Place this file in your packages directory (usually /config/packages/)
# See Home Assistant Packages documentation for further details on how to use this
# Packages in Home Assistant: https://www.home-assistant.io/docs/configuration/packages/
# This packages is created by Heino Skov. I do not provide any support on this but its free to use and
# edit to your needs. 

# This package provides a set of scripts and automations to optimize the use of a Huawei solar battery system.
# The scripts and automations in this package is setup for a 10kWh inverter and 10kW battery from Huawei.
# It aims to maximize self-consumption, optimize charging/discharging of Huawei Battery based on electricity prices,
# and manage grid export based on spot prices.

# --------------------------------------------------------------------------------------
# Brief explanation
# Daily processes:
# The daily optimization runs at 6:00 AM, triggering energy threshold calculations, hourly data analysis, and
# summary generation.
# At 6:05 AM, the system implements the daily optimization, initially setting the working mode to TOU with 
# disabled battery, and potentially scheduling a mode change.
# Throughout the day, the system checks every 5 minutes if it's time to change the mode to Maximize Self Consumption.
# At 5:00 PM, the system switches to an appropriate mode based on the month.
# At 9:00 PM, the system calculates the charging strategy for the next day, setting either TOU or Maximise Self 
# Consumption for the coming night

# Monthly process:
# On the 1st of each month, the system checks and sets the appropriate working mode based on the season.

# Continuous processes:
# The system manages inverter export based on spot prices, triggered by price changes or hourly checks.

# Available scripts:
# There is various scripts available for setting different working modes, managing grid export, and calculating 
# charging strategies.
# Some of these are used in automations and some is there to use manually or for further automation improvements. 
# --------------------------------------------------------------------------------------

# --------------------------------------------------------------------------------------
# Requirements to use below scripts / automations
# Huawai Solar integration by wlcrs: https://github.com/wlcrs/huawei_solar
# Solcast integration by oziee: https://github.com/BJReplay/ha-solcast-solar 
# Energi Data Service integration by MTrab: https://github.com/MTrab/energidataservice 
# Huawei Solar PEES package by JensenNick https://github.com/JensenNick/huawei_solar_pees (not required but nice addon to Huawei)
# --------------------------------------------------------------------------------------

# --------------------------------------------------------------------------------------
# A few input sensors may need to be adjusted:
# sensor.solcast_pv_forecast_forecast_today (from Solcast integration)
# sensor.solcast_pv_forecast_forecast_tomorrow (from Solcast integration)
# sensor.energi_data_service_total_price (from Energi Data Service integration)
# sensor.energi_data_service_spot_price (from Energi Data Service integration)
# sensor.batteries_state_of_capacity (from Huawei Solar Integration)
# sensor.inverter_active_power_control (from Huawei Solar Integration)
# --------------------------------------------------------------------------------------

# --------------------------------------------------------------------------------------
# Roadmap features:
# 1. Adjustable AMP configuration for EV Charging (Wallbox Pulsar Plus) based on excessive PV production after house load
# 2. Peak shaving / Capacity Control
# --------------------------------------------------------------------------------------

# Helpers to support the various scripts and automations
input_number:
  hsbo_energy_avg_price:
    name: HSBO Energy Average Price
    min: 0
    max: 10
    step: 0.01
    unit_of_measurement: DKK/kWh
  hsbo_energy_high_threshold:
    name: HSBO Energy High Threshold
    min: 0
    max: 10
    step: 0.01
    unit_of_measurement: DKK/kWh
  hsbo_energy_low_threshold:
    name: HSBO Energy Low Threshold
    min: 0
    max: 10
    step: 0.01
    unit_of_measurement: DKK/kWh
  hsbo_grid_selling:
    name: HSBO Grid Selling
    min: 0
    max: 100
    step: 0.01
    unit_of_measurement: kWh
  hsbo_battery_charging:
    name: HSBO Battery Charging
    min: 0
    max: 10
    step: 0.01
    unit_of_measurement: kWh
  hsbo_remaining_charge:
    name: HSBO Remaining Charge
    min: 0
    max: 10
    initial: 10
    step: 0.01
    unit_of_measurement: kWh
    icon: mdi:battery-charging
  hsbo_simulated_remaining_charge:
    name: HSBO Simulated Remaining Charge
    min: 0
    max: 10
    initial: 10
    step: 0.01
    unit_of_measurement: kWh
    icon: mdi:battery-charging-outline
  hsbo_charge_start_time:
    name: HSBO Charge Start Time
    min: 0
    max: 23
    step: 1
    unit_of_measurement: hour
    icon: mdi:clock-start
  hsbo_solar_charging_capacity:
    name: HSBO Solar Charging Capacity
    min: 0
    max: 100  # Increase this to a value that comfortably exceeds your maximum possible daily production
    step: 0.01
    unit_of_measurement: kWh
  hsbo_required_grid_charging:
    name: HSBO Required Grid Charging
    min: 0
    max: 10
    step: 0.01
    unit_of_measurement: kWh
  hsbo_ac_charge_cutoff_soc:
    name: HSBO AC Charge Cutoff SOC
    min: 0
    max: 100
    step: 1
    unit_of_measurement: '%'
  
  # This is a user configured helper to configure your solar plants max battery capacity
  hsbo_battery_max_capacity:
    name: HSBO Battery Max Capacity
    min: 1
    max: 100
    step: 0.1
    unit_of_measurement: kWh
    icon: mdi:battery
  
  # This is a user configured helper to configure your house load between 6am and 9am (for which battery should have enough capacity to cover)
  hsbo_morning_energy_need:
    name: HSBO Morning Energy Need
    min: 0
    max: 10
    step: 0.1
    unit_of_measurement: kWh
    icon: mdi:flash

input_text:
  hsbo_hourly_decision:
    name: HSBO Hourly Decision
  hsbo_recommendation_6:
    name: HSBO Recommendation for 6:00
  hsbo_recommendation_7:
    name: HSBO Recommendation for 7:00
  hsbo_recommendation_8:
    name: HSBO Recommendation for 8:00
  hsbo_recommendation_9:
    name: HSBO Recommendation for 9:00
  hsbo_recommendation_10:
    name: HSBO Recommendation for 10:00
  hsbo_recommendation_11:
    name: HSBO Recommendation for 11:00
  hsbo_recommendation_12:
    name: HSBO Recommendation for 12:00
  hsbo_recommendation_13:
    name: HSBO Recommendation for 13:00
  hsbo_recommendation_14:
    name: HSBO Recommendation for 14:00
  hsbo_recommendation_15:
    name: HSBO Recommendation for 15:00
  hsbo_recommendation_16:
    name: HSBO Recommendation for 16:00
  hsbo_recommended_working_mode:
    name: HSBO Recommended Working Mode
  hsbo_device_id_inverter:
    name: HSBO Device ID for Huawei Solar device - Inverter
  hsbo_device_id_batteries:
    name: HSBO Device ID for Huawei Solar device - Batteries
  hsbo_batteries_grid_charge_cutoff_soc:
    name: HSBO Sensor for number.batteries_grid_charge_cutoff_soc
  hsbo_batteries_working_mode:
    name: HSBO Sensor for select.batteries_working_mode
  hsbo_batteries_excess_pv_energy_use_in_tou:
    name: HSBO Sensor for select.batteries_excess_pv_energy_use_in_tou
  hsbo_energi_data_service_total_price:
    name: HSBO Sensor for sensor.energi_data_service
  hsbo_energi_data_service_spot_price:
    name: HSBO Sensor for sensor.energi_data_service_produktion
  hsbo_solcast_pv_forecast_forecast_today:
    name: HSBO Sensor for sensor.solcast_pv_forecast_forecast_today
  hsbo_solcast_pv_forecast_forecast_tomorrow:
    name: HSBO Sensor for sensor.solcast_pv_forecast_forecast_tomorrow
  hsbo_batteries_state_of_capacity:
    name: HSBO Sensor for batteries_state_of_capacity
  hsbo_inverter_active_power_control:
    name: HSBO Sensor for sensor.inverter_active_power_control
  hsbo_house_consumption_power:
    name: HSBO Sensor for house consumption power
  hsbo_solar_production_power:
    name: HSBO Sensor for solar production power
  hsbo_ev_charger_status:
    name: HSBO Sensor for EV charging status
  hsbo_current_priority_mode:
    name: HSBO Sensor for current priority mode
    
input_datetime:
  hsbo_next_mode_change_time:
    name: HSBO Next Mode Change Time
    has_date: true
    has_time: true

# Binary Sensors
binary_sensor:
  - platform: template
    sensors:
      hsbo_negative_spot_price:
        friendly_name: "HSBO Negative Spot Price"
        unique_id: hsbo_negative_spot_price
        value_template: >
          {{ states(states('input_text.hsbo_energi_data_service_spot_price')) | float < 0 }}
        attribute_templates:
          energi_data_service_price: "{{ states(states('input_text.hsbo_energi_data_service_spot_price')) }}"

  - platform: template
    sensors:
      hsbo_ev_charging:
        friendly_name: "HSBO EV Charging Status"
        value_template: >-
          {% set ev_status = states(states('input_text.hsbo_ev_charger_status')) | lower %}
          {{ ev_status in ['charging', 'charging scheduled'] }}

# Scripts
script:
  hsbo_calculate_energy_thresholds:
    alias: "HSBO Calculate Energy Thresholds"
    # This script calculates the average, high, and low energy price thresholds for the day.
    # These thresholds are used to make decisions about when to charge the battery or sell to the grid.
    sequence:
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_energy_avg_price
        data:
          value: "{{ state_attr(states('input_text.hsbo_energi_data_service_total_price'), 'today_mean') | float }}"
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_energy_high_threshold
        data:
          value: "{{ (state_attr(states('input_text.hsbo_energi_data_service_total_price'), 'today_max')['price'] | float) * 0.95}}"
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_energy_low_threshold
        data:
          value: "{{ (state_attr(states('input_text.hsbo_energi_data_service_total_price'), 'today_min')['price'] | float) * 1.05}}"

  hsbo_analyze_hourly_data:
    alias: "HSBO Analyze Hourly Data"
    # This script analyzes the hourly solar production forecast and electricity prices.
    # It makes decisions about whether to charge the battery, sell to the grid, or use the energy
    # for each hour of the day, and updates the relevant input numbers and texts.
    sequence:
      - action: system_log.write
        data:
          message: "HSBO: Starting hourly data analysis"
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_grid_selling
        data:
          value: 0
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_battery_charging
        data:
          value: 0
      - action: system_log.write
        data:
          message: "HSBO: Battery capacity sensor value: states(states('input_text.hsbo_batteries_state_of_capacity'))"
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_remaining_charge
        data:
          value: >
            {% set battery_capacity = states(states('input_text.hsbo_batteries_state_of_capacity')) | float %}
            {% set max_capacity = states('input_number.hsbo_battery_max_capacity') | float %}
            {% if battery_capacity != 'unknown' and battery_capacity != 'unavailable' %}
              {{ ((100 - battery_capacity) / 100 * max_capacity) | round(2) }}
            {% else %}
              {{ max_capacity | round(2) }}
            {% endif %}
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_simulated_remaining_charge
        data:
          value: "{{ states('input_number.hsbo_remaining_charge') }}"
      - action: homeassistant.update_entity
        target:
          entity_id: input_number.hsbo_remaining_charge
      - action: system_log.write
        data:
          message: "HSBO: Actual remaining charge set to: {{ states('input_number.hsbo_remaining_charge') }} kWh (Battery at states(states('input_text.hsbo_batteries_state_of_capacity')) %)"
      - repeat:
          count: 11
          sequence:
            - variables:
                current_hour: "{{ repeat.index + 5 }}"
                hour_forecast: >
                  {% set forecast = state_attr(states('input_text.hsbo_solcast_pv_forecast_forecast_today'), 'detailedHourly') %}
                  {{ forecast[current_hour].pv_estimate * 0.9 | float(0) if forecast != None else 0.0 }}
            - action: script.hsbo_process_hourly_data
              data:
                hour: "{{ current_hour }}"
                hour_forecast: "{{ hour_forecast }}"
            - action: script.hsbo_update_hourly_recommendation
              data:
                hour: "{{ current_hour }}"
                hour_forecast: "{{ hour_forecast }}"

  hsbo_process_hourly_data:
    alias: "HSBO Process Hourly Data"
    # This script processes the data for a specific hour, determining whether to sell to the grid,
    # charge the battery, or use the energy based on the current price and battery state.
    sequence:
      - variables:
          hour_price: "{{ state_attr(states('input_text.hsbo_energi_data_service_total_price'), 'raw_today')[hour].price }}"
          charging_amount: "{{ [hour_forecast, 5, states('input_number.hsbo_simulated_remaining_charge') | float] | min }}"
      - choose:
          - conditions:
              - "{{ hour < 12 or hour_price > states('input_number.hsbo_energy_high_threshold') | float }}"
            sequence:
              - action: input_number.set_value
                target:
                  entity_id: input_number.hsbo_grid_selling
                data:
                  value: "{{ states('input_number.hsbo_grid_selling') | float + hour_forecast }}"
              - action: input_text.set_value
                target:
                  entity_id: input_text.hsbo_hourly_decision
                data:
                  value: "Sell to Grid"
          - conditions:
              - "{{ states('input_number.hsbo_simulated_remaining_charge') | float > 0 }}"
              - "{{ hour_price < states('input_number.hsbo_energy_low_threshold') | float }}"
            sequence:
              - action: input_number.set_value
                target:
                  entity_id: input_number.hsbo_battery_charging
                data:
                  value: "{{ states('input_number.hsbo_battery_charging') | float + charging_amount }}"
              - action: input_number.set_value
                target:
                  entity_id: input_number.hsbo_simulated_remaining_charge
                data:
                  value: "{{ states('input_number.hsbo_simulated_remaining_charge') | float - charging_amount }}"
              - action: input_text.set_value
                target:
                  entity_id: input_text.hsbo_hourly_decision
                data:
                  value: "Charge Battery"
          - conditions:
              - "{{ states('input_number.hsbo_simulated_remaining_charge') | float > 0 }}"
            sequence:
              - action: input_number.set_value
                target:
                  entity_id: input_number.hsbo_battery_charging
                data:
                  value: "{{ states('input_number.hsbo_battery_charging') | float + charging_amount }}"
              - action: input_number.set_value
                target:
                  entity_id: input_number.hsbo_simulated_remaining_charge
                data:
                  value: "{{ states('input_number.hsbo_simulated_remaining_charge') | float - charging_amount }}"
              - action: input_text.set_value
                target:
                  entity_id: input_text.hsbo_hourly_decision
                data:
                  value: "Charge Battery (if needed)"
        default:
          - action: input_number.set_value
            target:
              entity_id: input_number.hsbo_grid_selling
            data:
              value: "{{ states('input_number.hsbo_grid_selling') | float + hour_forecast }}"
          - action: input_text.set_value
            target:
              entity_id: input_text.hsbo_hourly_decision
            data:
              value: "Sell to Grid (Battery Full)"

  hsbo_update_hourly_recommendation:
    alias: "HSBO Update Hourly Recommendation"
    # This script updates the recommendation for a specific hour based on the decision made
    # in the hsbo_process_hourly_data script.
    sequence:
      - action: input_text.set_value
        target:
          entity_id: "input_text.hsbo_recommendation_{{ hour }}"
        data:
          value: >
            {{ hour }}:00: {{ states('input_text.hsbo_hourly_decision') }}
            {% if states('input_text.hsbo_hourly_decision') == 'Charge Battery' %}
            - Charge up to {{ [hour_forecast, 5]|min|round(2) }} kWh
            {% elif states('input_text.hsbo_hourly_decision') == 'Sell to Grid' %}
            - Potential to sell {{ hour_forecast|round(2) }} kWh
            {% endif %}

  hsbo_generate_summary:
    alias: "HSBO Generate Battery Optimization Summary"
    # This script generates a summary of the battery optimization analysis, including
    # potential grid selling, battery charging, and recommendations for each hour.
    # It also determines the optimal time to start charging the battery.
    sequence:
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_charge_start_time
        data:
          value: 0
      - action: system_log.write
        data:
          message: "HSBO: Starting hourly analysis to determine charge start time"
      - repeat:
          count: 11
          sequence:
            - variables:
                current_hour: "{{ repeat.index + 5 }}"
                current_recommendation: "{{ states('input_text.hsbo_recommendation_' ~ current_hour) }}"
            - action: system_log.write
              data:
                message: >
                  HSBO: Analyzing hour {{ current_hour }}:00 - Recommendation: {{ current_recommendation }}
            - choose:
                - conditions:
                    - condition: template
                      value_template: >
                        {{ 'Charge Battery' in current_recommendation and
                          'if needed' not in current_recommendation and
                          states('input_number.hsbo_charge_start_time') | float == 0 }}
                  sequence:
                    - action: input_number.set_value
                      target:
                        entity_id: input_number.hsbo_charge_start_time
                      data:
                        value: "{{ current_hour }}"
                    - action: system_log.write
                      data:
                        message: "HSBO: Charge start time set to {{ current_hour }}:00 (First occurrence of 'Charge Battery')"
      - action: persistent_notification.create
        data:
          title: "HSBO Battery Optimization Summary"
          message: >
            {% set grid_selling = states('input_number.hsbo_grid_selling') | float %}
            {% set battery_charging = states('input_number.hsbo_battery_charging') | float %}
            {% set actual_remaining_charge = states('input_number.hsbo_remaining_charge') | float %}
            {% set simulated_remaining_charge = states('input_number.hsbo_simulated_remaining_charge') | float %}
            {% set charge_start_hour = states('input_number.hsbo_charge_start_time') | int %}

            Battery Optimization Summary:{{ '\n' -}}
            --------------------------------{{ '\n' -}}
            Current remaining charge: {{ actual_remaining_charge | round(2) }} kWh{{ '\n' -}}
            Simulated remaining charge after optimizations: {{ simulated_remaining_charge | round(2) }} kWh{{ '\n' -}}
            Total potential grid selling: {{ grid_selling | round(2) }} kWh{{ '\n' -}}
            Total potential battery charging: {{ battery_charging | round(2) }} kWh{{ '\n' -}}
            {{ '\n' -}}
            {% if simulated_remaining_charge <= 0 %}
            The battery can be fully charged to 100% by 17:00 based on the simulation.{{ '\n' -}}
            {% else %}
            Warning: The simulation shows the battery may not be fully charged by 17:00.{{ '\n' -}}
            Consider adjusting the charging strategy or using grid power during the lowest-priced hours.{{ '\n' -}}
            {% endif %}
            {{ '\n' -}}
            Hourly Recommendations:{{ '\n' -}}
            --------------------------------
            {% for hour in range(6, 17) %}
            {{ states('input_text.hsbo_recommendation_' ~ hour) | replace(hour | string ~ ':00: ', hour | string ~ ':00 - ') }}{{ '\n' -}}
            {% endfor %}
            {{ '\n' -}}
            Conclusion:{{ '\n' -}}
            --------------------------------{{ '\n' -}}
            {% if charge_start_hour > 0 %}
            Recommended battery charging start time: {{ charge_start_hour }}:00{{ '\n' -}}
            {% else %}
            No specific battery charging time recommended. Consider selling to grid or manual adjustment.{{ '\n' -}}
            {% endif %}
      - action: system_log.write
        data:
          message: "HSBO: Hourly analysis complete. Final charge start time: {{ states('input_number.hsbo_charge_start_time') }}:00"

  hsbo_set_working_mode_to_default_tou_periods:
    alias: "HSBO - Set Working Mode to Default TOU Periods"
    # This script sets the Huawei Solar system to use default Time-of-Use (TOU) periods.
    # It configures charging from midnight to 6am and discharging from 5pm to midnight.
    # It also sets the excess PV energy priority to "charge"
    sequence:
      - action: huawei_solar.set_tou_periods
        data:
          periods: |-
            00:01-05:59/1234567/+
            06:00-10:00/1234567/-
            17:00-23:59/1234567/-
          device_id: "{{ states('input_text.hsbo_device_id_batteries') }}"
      - action: select.select_option
        target:
          entity_id: "{{ states('input_text.hsbo_batteries_excess_pv_energy_use_in_tou') }}"
        data:
          option: charge
      - delay:
          seconds: 10
      - action: select.select_option
        target:
          entity_id: "{{ states('input_text.hsbo_batteries_working_mode') }}"
        data:
          option: time_of_use_luna2000
      - action: notify.notify
        data:
          message: Huawei Solar Working Mode set to Default TOU
    mode: single
    description: "This is the default TOU with two periods. One for charging from midnight to 6am and one for discharging from 5pm to midnight"

  hsbo_set_working_mode_to_fully_fed_to_grid:
    alias: "HSBO - Set Working Mode to Fully Fed to Grid"
    # This script sets the Huawei Solar system to feed all generated power to the grid.
    # This mode is useful when electricity prices are consistently high.
    sequence:
      - action: select.select_option
        target:
          entity_id: "{{ states('input_text.hsbo_batteries_working_mode') }}"
        data:
          option: fully_fed_to_grid
      - action: notify.notify
        data:
          message: Huawei Solar Working Mode set to Fully Fed to Grid
    description: "This forces the Solar Plant to Fully Fed to Grid"

  hsbo_set_working_mode_to_maximise_self_consumption:
    alias: "HSBO - Set Working Mode to Maximise Self Consumption"
    # This script sets the Huawei Solar system to maximize self-consumption of generated power.
    # In this mode, the system prioritizes using solar power for household consumption and
    # battery charging before feeding excess to the grid.
    sequence:
      - action: select.select_option
        target:
          entity_id: "{{ states('input_text.hsbo_batteries_working_mode') }}"
        data:
          option: maximise_self_consumption
      - action: notify.notify
        data:
          message: Huawei Solar Working Mode set to Maximise Self Consumption
    description: "This script enables the Maximise Self Consumption working mode. TOU is not used in this mode"

  hsbo_set_working_mode_to_tou_and_disable_battery_charging_and_discharging:
    alias: "HSBO - Set Working Mode to TOU and Disable Battery Charging and Discharging"
    # This script sets the system to a special TOU mode where battery charging and discharging
    # are disabled. All excess power is fed to the grid. This can be useful during periods
    # of consistently high grid prices or when you charge your electric vehichle to avoid 
    # discharging the battery during EV charging.
    sequence:
      - action: huawei_solar.set_tou_periods
        data:
          periods: 00:00-00:01/1234567/+
          device_id: "{{ states('input_text.hsbo_device_id_batteries') }}"
      - action: select.select_option
        target:
          entity_id: "{{ states('input_text.hsbo_batteries_excess_pv_energy_use_in_tou') }}"
        data:
          option: fed_to_grid
      - delay:
          seconds: 10
      - action: select.select_option
        target:
          entity_id: "{{ states('input_text.hsbo_batteries_working_mode') }}"
        data:
          option: time_of_use_luna2000
      - action: notify.notify
        data:
          message: Huawei Solar Working Mode set to TOU with Disabled Battery Charging and Discharging
    mode: single
    description: "This script enables TOU and disables use of battery for both discharging and charging. Excess power produced will be fed to grid"

  hsbo_disable_grid_export:
    alias: "HSBO - Disable Grid Export"
    # This script disables exporting power to the grid. It's typically used when electricity
    # prices are negative to avoid selling power at a loss.
    sequence:
      - action: huawei_solar.set_maximum_feed_grid_power_percent
        data:
          device_id: "{{ states('input_text.hsbo_device_id_inverter') }}"
          power_percentage: 0
      - action: notify.notify
        data:
          message: "HSBO: Solar Inverter GRID EXPORT disabled"
    mode: single
    description: "Disables grid export and sends notifications"

  hsbo_enable_grid_export:
    alias: "HSBO - Enable Grid Export"
    # This script enables exporting power to the grid. It's used when electricity prices
    # are positive and it's beneficial to sell excess power.
    sequence:
      - action: huawei_solar.set_maximum_feed_grid_power_percent
        data:
          device_id: "{{ states('input_text.hsbo_device_id_inverter') }}"
          power_percentage: 100
      - action: notify.notify
        data:
          message: "HSBO: Solar Inverter GRID EXPORT enabled"
    mode: single
    description: "Enables grid export and sends notifications"

  hsbo_calculate_next_day_charging:
    alias: "HSBO Calculate Next Day Charging Strategy"
    sequence:
      - action: system_log.write
        data:
          message: "HSBO: Starting next day charging calculation"
      
      # Get current battery SoC and system parameters
      - variables:
          current_battery_soc: "{{ states(states('input_text.hsbo_batteries_state_of_capacity')) | float(0) }}"
          battery_max_capacity: "{{ states('input_number.hsbo_battery_max_capacity') | float(10) }}"
          current_battery_capacity: "{{ (current_battery_soc / 100 * battery_max_capacity) | round(2) }}"
          current_month: "{{ now().month }}"
      
      - action: system_log.write
        data:
          message: "HSBO Debug: Current battery SoC: {{ current_battery_soc }}%, Capacity: {{ current_battery_capacity }} kWh, Current month: {{ current_month }}"
      
      # Get tomorrow's solar forecast with debug logging
      - variables:
          tomorrow_forecast_raw: "{{ state_attr(states('input_text.hsbo_solcast_pv_forecast_forecast_tomorrow'), 'estimate') }}"
      - action: system_log.write
        data:
          message: "HSBO Debug: Raw tomorrow forecast: {{ tomorrow_forecast_raw }}"
      
      - variables:
          tomorrow_forecast: >
            {% if tomorrow_forecast_raw is not none and tomorrow_forecast_raw | float(-1) >= 0 %}
              {{ tomorrow_forecast_raw | float }}
            {% elif state_attr(states('input_text.hsbo_solcast_pv_forecast_forecast_today'), 'estimate') is not none 
                    and state_attr(states('input_text.hsbo_solcast_pv_forecast_forecast_today'), 'estimate') | float(-1) >= 0 %}
              {{ state_attr(states('input_text.hsbo_solcast_pv_forecast_forecast_today'), 'estimate') | float }}
            {% else %}
              5
            {% endif %}
      
      - action: system_log.write
        data:
          message: "HSBO: Tomorrow's forecast: {{ tomorrow_forecast }} kWh"
      
      # Calculate estimated solar charging capacity (assuming 90% efficiency)
      - variables:
          solar_charging_capacity: "{{ (tomorrow_forecast | float * 0.9) | round(2) }}"
      
      - action: system_log.write
        data:
          message: "HSBO Debug: Solar charging capacity: {{ solar_charging_capacity }} kWh"
      
      # Calculate energy needed for morning usage (6am to 9am), only for September to April
      - variables:
          morning_energy_need: >
            {% if current_month in [1, 2, 3, 4, 9, 10, 11, 12] %}
              {{ states('input_number.hsbo_morning_energy_need') | float(1.5) }}
            {% else %}
              0
            {% endif %}
      
      - action: system_log.write
        data:
          message: "HSBO Debug: Morning energy need: {{ morning_energy_need }} kWh (Considered: {{ current_month in [1, 2, 3, 4, 9, 10, 11, 12] }})"
      
      # Calculate required charging from grid
      - variables:
          target_capacity: "{{ battery_max_capacity * 0.9 }}"
          solar_charging_capacity_float: "{{ solar_charging_capacity | float(0) }}"
          required_energy: "{{ (target_capacity - current_battery_capacity) | float(0) }}"
          solar_excess: "{{ (solar_charging_capacity_float - required_energy) | float(0) }}"
          required_grid_charging: >
            {% if solar_excess < 0 %}
              {{ ((-solar_excess) | abs + morning_energy_need) | round(2) }}
            {% else %}
              {{ morning_energy_need | round(2) }}
            {% endif %}
          recommended_working_mode: >
            {% if required_grid_charging > 0 %}
              TOU
            {% else %}
              Maximise Self Consumption
            {% endif %}
      
      - action: system_log.write
        data:
          message: >
            HSBO Debug: Charging strategy calculation:
            Max capacity: {{ battery_max_capacity }} kWh,
            Target capacity: {{ target_capacity }} kWh,
            Current battery capacity: {{ current_battery_capacity }} kWh,
            Solar charging capacity: {{ solar_charging_capacity_float }} kWh,
            Required energy: {{ required_energy }} kWh,
            Solar excess: {{ solar_excess }} kWh,
            Morning energy need: {{ morning_energy_need }} kWh,
            Required grid charging: {{ required_grid_charging }} kWh,
            Recommended working mode: {{ recommended_working_mode }}

      # Calculate AC charge cutoff SOC (for TOU mode) with error handling
      - variables:
          ac_charge_cutoff_soc: >
            {% if required_grid_charging > 0 %}
              {% set cutoff_percentage = (((target_capacity + morning_energy_need) / battery_max_capacity) * 100) | round(0) %}
              {{ [[cutoff_percentage, 100] | min, 20] | max | float }}
            {% else %}
              {{ 20 | float }}
            {% endif %}
      
      - action: system_log.write
        data:
          message: >
            HSBO Debug: AC charge cutoff SOC calculation:
            AC charge cutoff SOC: {{ ac_charge_cutoff_soc }}%
            (Note: Only relevant if TOU mode is used)

      # Set the calculated values with error handling
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_solar_charging_capacity
        data:
          value: "{{ solar_charging_capacity_float | float(0) }}"
      
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_required_grid_charging
        data:
          value: "{{ required_grid_charging | float(0) }}"
      
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_ac_charge_cutoff_soc
        data:
          value: "{{ ac_charge_cutoff_soc | float(0) }}"
      
      - action: input_text.set_value
        target:
          entity_id: input_text.hsbo_recommended_working_mode
        data:
          value: "{{ recommended_working_mode }}"
      
      - action: system_log.write
        data:
          message: >
            HSBO: Next day charging calculation complete. 
            Solar charging capacity: {{ solar_charging_capacity_float | float(0) }} kWh, 
            Required grid charging: {{ required_grid_charging | float(0) }} kWh,
            AC charge cutoff SOC: {{ ac_charge_cutoff_soc | float(0) }}%,
            Recommended working mode: {{ recommended_working_mode }}

# Automations
automation:
  - id: hsbo_daily_battery_optimization
    alias: "HSBO Daily Battery Optimization"
    # This automation runs daily at 6:00 AM to perform the battery optimization analysis
    # for the upcoming day. It calculates energy thresholds/pricing, analyzes hourly forecast data, and
    # generates a summary of recommendations.
    trigger:
      - platform: time
        at: "06:00:00"
    action:
      - action: input_number.set_value
        target:
          entity_id: input_number.hsbo_charge_start_time
        data:
          value: 0
      - action: number.set_value
        target:
          entity_id: "{{ states('input_text.hsbo_batteries_grid_charge_cutoff_soc') }}"
        data:
          value: "{{ states('input_number.hsbo_ac_charge_cutoff_soc') | int }}"
      - action: script.hsbo_calculate_energy_thresholds
      - action: script.hsbo_analyze_hourly_data
      - action: script.hsbo_generate_summary

  - id: hsbo_set_battery_charge_time
    alias: "HSBO Set Battery Charge Time"
    description: "Set the optimalt time to charge battery"
    trigger:
      - platform: time
        at: "06:05:00"
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: input_number.hsbo_charge_start_time
                above: 0
            sequence:
              - action: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.hsbo_next_mode_change_time
                data:
                  datetime: "{{ states('sensor.hsbo_next_mode_change_time') }}"
              - action: system_log.write
                data:
                  message: >
                    HSBO: Set next mode change time to {{ states('sensor.hsbo_next_mode_change_time') }}.
                    Current time: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
        default:
          - action: system_log.write
            data:
              message: "HSBO: No specific charge start time set, staying with Default TOU settings"
 
  # Replaced by automation hsbo_comprehensive_daily_mode_management - remove this section after October 10th 2024
  # - id: hsbo_check_and_change_mode
  #   alias: "HSBO Check and Change Mode"
  #   trigger:
  #     - platform: time_pattern
  #       minutes: "/5"
  #   condition:
  #     - condition: template
  #       value_template: >
  #         {{ states('input_datetime.hsbo_next_mode_change_time') != 'unavailable' 
  #           and states('input_datetime.hsbo_next_mode_change_time') != 'unknown'
  #           and now() | as_timestamp >= states.input_datetime.hsbo_next_mode_change_time.state | as_timestamp }}
  #   action:
  #     - action: script.turn_on
  #       target:
  #         entity_id: script.hsbo_set_working_mode_to_maximise_self_consumption
  #     - action: system_log.write
  #       data:
  #         message: "HSBO: Switched to Maximise Self Consumption at {{ now().strftime('%H:%M:%S') }}"
  #     - action: input_datetime.set_datetime
  #       target:
  #         entity_id: input_datetime.hsbo_next_mode_change_time
  #       data:
  #         datetime: "{{ (now() + timedelta(days=1)).strftime('%Y-%m-%d 00:00:00') }}"

  # Replaced by automation hsbo_comprehensive_daily_mode_management - remove this section after October 10th 2024
  # - id: hsbo_switch_to_appropriate_mode_at_5pm
  #   alias: "HSBO Switch to Appropriate Mode at 5 PM"
  #   # This automation switches the system to an appropriate mode at 5 PM based on the season.
  #   # In from october to april, it uses the default TOU mode. from May to September, it use 
  #   # maximize self-consumption working mode
  #   trigger:
  #     - platform: time
  #       at: "17:00:00"
  #   action:
  #     - choose:
  #         - conditions:
  #             - condition: template
  #               value_template: >
  #                 {{ now().month in [10, 11, 12, 1, 2, 3, 4] }}
  #           sequence:
  #             - action: script.turn_on
  #               target:
  #                 entity_id: script.hsbo_set_working_mode_to_default_tou_periods
  #             - action: system_log.write
  #               data:
  #                 message: "HSBO: Switched to Default TOU Mode at 5 PM (Winter/Spring months)"
  #       default:
  #         - action: script.turn_on
  #           target:
  #             entity_id: script.hsbo_set_working_mode_to_maximise_self_consumption
  #         - action: system_log.write
  #           data:
  #             message: "HSBO: Switched to Maximise Self Consumption at 5 PM (Summer/Fall months)"

  # Replaced by automation hsbo_comprehensive_daily_mode_management - remove this section after October 10th 2024
  # - id: hsbo_monthly_mode_check
  #   alias: "HSBO Monthly Mode Check"
  #   # This automation runs at the start of each month to set the appropriate working mode
  #   # based on the season. It helps ensure the system is operating optimally as seasons change.
  #   trigger:
  #     - platform: time
  #       at: "00:00:01"
  #   condition:
  #     - condition: template
  #       value_template: "{{ now().day == 1 }}"
  #   action:
  #     - choose:
  #         - conditions:
  #             - condition: template
  #               value_template: >
  #                 {{ now().month in [10, 11, 12, 1, 2, 3, 4] }}
  #           sequence:
  #             - action: script.turn_on
  #               target:
  #                 entity_id: script.hsbo_set_working_mode_to_default_tou_periods
  #             - action: system_log.write
  #               data:
  #                 message: "HSBO: Set to Default TOU Mode for the new month (Winter/Spring)"
  #       default:
  #         - action: script.turn_on
  #           target:
  #             entity_id: script.hsbo_set_working_mode_to_maximise_self_consumption
  #         - action: system_log.write
  #           data:
  #             message: "HSBO: Set to Maximise Self Consumption for the new month (Summer/Fall)"

  # Replaced by automation hsbo_comprehensive_daily_mode_management - remove this section after October 10th 2024
  # - id: hsbo_manage_inverter_export_based_on_spot_price
  #   alias: "HSBO: Manage inverter export based on spot price"
  #   description: "Manages inverter export based on electricity spot price between 7 AM and 8 PM, avoiding redundant actions"
  #   trigger:
  #     - platform: state
  #       entity_id:
  #         - binary_sensor.hsbo_negative_spot_price
  #       id: price_change
  #     - platform: time_pattern
  #       hours: "*"
  #       minutes: "0"
  #       id: hourly_check
  #   condition:
  #     - condition: time
  #       after: "07:00:00"
  #       before: "20:00:00"
  #   variables:
  #     spot_price: "{{ states(states('input_text.hsbo_energi_data_service_spot_price')) | float }}"
  #     current_export_state: "{{ states(states('input_text.hsbo_inverter_active_power_control')) }}"
  #   action:
  #     - choose:
  #         - conditions:
  #             - condition: trigger
  #               id: price_change
  #           sequence:
  #             - choose:
  #                 - conditions:
  #                     - condition: state
  #                       entity_id: binary_sensor.hsbo_negative_spot_price
  #                       state: 'on'
  #                     - condition: not
  #                       conditions:
  #                         - condition: state
  #                           entity_id: {{ states('input_text.hsbo_inverter_active_power_control') }}
  #                           state: "Limited to 0.0%"
  #                   sequence:
  #                     - action: script.turn_on
  #                       target:
  #                         entity_id: script.hsbo_disable_grid_export
  #                 - conditions:
  #                     - condition: state
  #                       entity_id: binary_sensor.hsbo_negative_spot_price
  #                       state: 'off'
  #                     - condition: not
  #                       conditions:
  #                         - condition: state
  #                           entity_id: {{ states('input_text.hsbo_inverter_active_power_control') }}
  #                           state: "Limited to 100.0%"
  #                   sequence:
  #                     - action: script.turn_on
  #                       target:
  #                         entity_id: script.hsbo_enable_grid_export
  #         - conditions:
  #             - condition: trigger
  #               id: hourly_check
  #           sequence:
  #             - choose:
  #                 - conditions:
  #                     - condition: state
  #                       entity_id: binary_sensor.hsbo_negative_spot_price
  #                       state: 'on'
  #                     - condition: not
  #                       conditions:
  #                         - condition: state
  #                           entity_id: {{ states('input_text.hsbo_inverter_active_power_control') }}
  #                           state: "Limited to 0.0%"
  #                   sequence:
  #                     - action: script.turn_on
  #                       target:
  #                         entity_id: script.hsbo_disable_grid_export
  #                 - conditions:
  #                     - condition: state
  #                       entity_id: binary_sensor.hsbo_negative_spot_price
  #                       state: 'off'
  #                     - condition: not
  #                       conditions:
  #                         - condition: state
  #                           entity_id: {{ states('input_text.hsbo_inverter_active_power_control') }}
  #                           state: "Limited to 100.0%"
  #                   sequence:
  #                     - action: script.turn_on
  #                       target:
  #                         entity_id: script.hsbo_enable_grid_export
  #     - action: system_log.write
  #       data:
  #         message: >
  #           HSBO: Inverter export check - Energi Data Service price: {{ spot_price }} DKK/kWh, 
  #           Negative price: {{ states('binary_sensor.hsbo_negative_spot_price') }},
  #           Current export state: {{ current_export_state }},
  #           Action taken: {{ trigger.id }}
  #   mode: single

  - id: hsbo_calculate_next_day_charging_at_9_pm
    alias: "HSBO Calculate Next Day Charging at 9 PM"
    trigger:
      - platform: time
        at: "21:00:00"
    action:
      - action: script.turn_on
        target:
          entity_id: script.hsbo_calculate_next_day_charging
      - action: system_log.write
        data:
          message: "HSBO: Executed Calculate Next Day Charging script at {{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
    mode: single

  - id: hsbo_comprehensive_daily_mode_management
    alias: "HSBO Comprehensive Daily Mode Management"
    trigger:
      - platform: time_pattern
        minutes: "/5"
        id: regular_check
      - platform: time
        at: "00:00:01"
        id: midnight_check
      - platform: state
        entity_id:
          - binary_sensor.hsbo_negative_spot_price
        id: price_change
      - platform: state 
        entity_id:
          - binary_sensor.hsbo_ev_charging 
        to: 'on'
        id: ev_charging_start
      - platform: state 
        entity_id:
          - binary_sensor.hsbo_ev_charging 
        to: 'off'
        id: ev_charging_stop
    action:
      - variables:
          current_mode: "{{ states(states('input_text.hsbo_batteries_working_mode')) }}"
          ema_solar_production: "{{ states('sensor.hsbo_ema_solar_production') }}"
          ema_house_load: "{{ states('sensor.hsbo_ema_house_load') }}"
          differential_ema: >
            {% if is_number(ema_solar_production) and is_number(ema_house_load) %}
              {{ (ema_solar_production | float - ema_house_load | float) / 1000 }}
            {% else %}
              {% set solar_production = states('sensor.hsbo_solar_production') | float(0) %}
              {% set house_load = states('sensor.hsbo_house_consumption') | float(0) %}
              {{ (solar_production - house_load) / 1000 }}
            {% endif %}
          next_mode_change_time: "{{ states('input_datetime.hsbo_next_mode_change_time') }}"
          current_month: "{{ now().month }}"
          recommended_working_mode: "{{ states('input_text.hsbo_recommended_working_mode') }}"
          spot_price: "{{ states(states('input_text.hsbo_energi_data_service_spot_price')) | float }}"
          inverter_entity: "{{ states('input_text.hsbo_inverter_active_power_control') }}"
          current_export_state: "{{ states(inverter_entity) }}"
          ev_charging: "{{ is_state('binary_sensor.hsbo_ev_charging', 'on') }}"
      - choose:
          # EV Charging Start: Set to TOU and Disable Battery Charging and Discharging
          - conditions:
              - condition: trigger
                id: ev_charging_start
            sequence:
              - action: script.turn_on
                target:
                  entity_id: script.hsbo_set_working_mode_to_tou_and_disable_battery_charging_and_discharging
              - action: input_text.set_value
                target:
                  entity_id: input_text.hsbo_current_priority_mode
                data:
                  value: "ev_charging"
              - action: system_log.write
                data:
                  message: "HSBO: Changed to TOU with Disabled Battery Charging and Discharging due to EV charging start at {{ now().strftime('%H:%M:%S') }}"

          # EV Charging Stop: Revert to recommended mode
          - conditions:
              - condition: trigger
                id: ev_charging_stop
            sequence:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ recommended_working_mode == 'TOU' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_default_tou_periods
                  - conditions:
                      - condition: template
                        value_template: "{{ recommended_working_mode == 'Maximise Self Consumption' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_maximise_self_consumption
              - action: input_text.set_value
                target:
                  entity_id: input_text.hsbo_current_priority_mode
                data:
                  value: "default"
              - action: system_log.write
                data:
                  message: "HSBO: Reverted to {{ recommended_working_mode }} mode due to EV charging stop at {{ now().strftime('%H:%M:%S') }}"

          # Midnight: Set mode based on evening calculation (only if not EV charging)
          - conditions:
              - condition: trigger
                id: midnight_check
              - condition: state
                entity_id: binary_sensor.hsbo_ev_charging
                state: 'off'
            sequence:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ recommended_working_mode == 'TOU' and current_mode != 'time_of_use_luna2000' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_default_tou_periods
                      - action: system_log.write
                        data:
                          message: "HSBO: Set to Default TOU Mode at midnight based on evening calculation"
                  - conditions:
                      - condition: template
                        value_template: "{{ recommended_working_mode == 'Maximise Self Consumption' and current_mode != 'maximise_self_consumption' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_maximise_self_consumption
                      - action: system_log.write
                        data:
                          message: "HSBO: Set to Maximise Self Consumption at midnight based on evening calculation"
                default:
                  - action: system_log.write
                    data:
                      message: "HSBO: No change needed at midnight. Current mode: {{ current_mode }}"

          # Manage inverter export based on spot price (regardless of EV charging status)
          - conditions:
              - condition: trigger
                id: price_change
              - condition: time
                after: "07:00:00"
                before: "20:00:00"
            sequence:
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.hsbo_negative_spot_price
                        state: 'on'
                      - condition: template
                        value_template: >
                          {{ states(inverter_entity) != "Limited to 0.0%" }}
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_disable_grid_export
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.hsbo_negative_spot_price
                        state: 'off'
                      - condition: template
                        value_template: >
                          {{ states(inverter_entity) != "Limited to 100.0%" }}
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_enable_grid_export
              - action: system_log.write
                data:
                  message: >
                    HSBO: Inverter export check - Energi Data Service price: {{ spot_price }} DKK/kWh, 
                    Negative price: {{ states('binary_sensor.hsbo_negative_spot_price') }},
                    Current export state: {{ states(inverter_entity) }},
                    Action taken: {{ trigger.id if trigger is defined else 'Manual check' }}

          # Regular checks throughout the day (only if not EV charging)
          - conditions:
              - condition: trigger
                id: regular_check
              - condition: time
                after: "06:00:00"
                before: "23:59:59"
              - condition: state
                entity_id: binary_sensor.hsbo_ev_charging
                state: 'off'
            sequence:
              - choose:
                  # Between 6 AM and solar production <= house load
                  - conditions:
                      - condition: time
                        before: "10:00:00"
                      - condition: template
                        value_template: "{{ differential_ema <= -0.1 }}"
                      - condition: template
                        value_template: "{{ current_mode != 'time_of_use_luna2000' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_default_tou_periods
                      - action: system_log.write
                        data:
                          message: "HSBO: Changed to Default TOU mode at {{ now().strftime('%H:%M:%S') }} (Differential EMA: {{ differential_ema }} kW)"

                  # When solar production > house load, before next_mode_change_time
                  - conditions:
                      - condition: time
                        before: "17:00:00"
                      - condition: template
                        value_template: >
                          {% set next_change = strptime(next_mode_change_time, '%Y-%m-%d %H:%M:%S') %}
                          {{ differential_ema > 0.1 and 
                            now() | as_timestamp < next_change | as_timestamp }}
                      - condition: template
                        value_template: "{{ current_mode != 'fully_fed_to_grid' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_fully_fed_to_grid
                      - action: system_log.write
                        data:
                          message: "HSBO: Changed to Fully Fed to Grid at {{ now().strftime('%H:%M:%S') }} (Differential EMA: {{ differential_ema }} kW)"

                  # At or after next_mode_change_time, but before 5 PM
                  - conditions:
                      - condition: time
                        before: "17:00:00"
                      - condition: template
                        value_template: >
                          {% set next_change = strptime(next_mode_change_time, '%Y-%m-%d %H:%M:%S') %}
                          {{ now() | as_timestamp >= next_change | as_timestamp }}
                      - condition: template
                        value_template: "{{ current_mode != 'maximise_self_consumption' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_maximise_self_consumption
                      - action: system_log.write
                        data:
                          message: "HSBO: Changed to Maximise Self Consumption at {{ now().strftime('%H:%M:%S') }} (Differential EMA: {{ differential_ema }} kW)"

                  # After 5 PM (Winter/Spring months: September to April)
                  - conditions:
                      - condition: time
                        after: "17:00:00"
                      - condition: template
                        value_template: "{{ current_month in [9, 10, 11, 12, 1, 2, 3, 4] }}"
                      - condition: template
                        value_template: "{{ current_mode != 'time_of_use_luna2000' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_default_tou_periods
                      - action: system_log.write
                        data:
                          message: "HSBO: Changed to Default TOU Mode (Winter/Spring months) at {{ now().strftime('%H:%M:%S') }} (Differential EMA: {{ differential_ema }} kW)"

                  # After 5 PM (Summer months: May to August)
                  - conditions:
                      - condition: time
                        after: "17:00:00"
                      - condition: template
                        value_template: "{{ current_month in [5, 6, 7, 8] }}"
                      - condition: template
                        value_template: "{{ current_mode != 'maximise_self_consumption' }}"
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_set_working_mode_to_maximise_self_consumption
                      - action: system_log.write
                        data:
                          message: "HSBO: Changed to Maximise Self Consumption (Summer months) at {{ now().strftime('%H:%M:%S') }} (Differential EMA: {{ differential_ema }} kW)"

              # Check and manage inverter export during regular checks
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.hsbo_negative_spot_price
                        state: 'on'
                      - condition: template
                        value_template: >
                          {{ states(inverter_entity) != "Limited to 0.0%" }}
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_disable_grid_export
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.hsbo_negative_spot_price
                        state: 'off'
                      - condition: template
                        value_template: >
                          {{ states(inverter_entity) != "Limited to 100.0%" }}
                    sequence:
                      - action: script.turn_on
                        target:
                          entity_id: script.hsbo_enable_grid_export
              - action: system_log.write
                data:
                  message: >
                    HSBO: Inverter export check - Energi Data Service price: {{ spot_price }} DKK/kWh, 
                    Negative price: {{ states('binary_sensor.hsbo_negative_spot_price') }},
                    Current export state: {{ states(inverter_entity) }},
                    Action taken: Regular check
    mode: single
    
# Sensors
sensor:
  - platform: template
    sensors:
      hsbo_optimization_summary:
        friendly_name: "HSBO Battery Optimization Summary"
        unique_id: hsbo_optimization_summary
        # This sensor provides a summary of the daily optimization results, including
        # potential grid selling, battery charging, and remaining charge levels.
        value_template: >
          Grid Selling: {{ states('input_number.hsbo_grid_selling') }} kWh,
          Battery Charging: {{ states('input_number.hsbo_battery_charging') }} kWh,
          Actual Remaining Charge: {{ states('input_number.hsbo_remaining_charge') }} kWh,
          Simulated Remaining Charge: {{ states('input_number.hsbo_simulated_remaining_charge') }} kWh

  - platform: template
    sensors:
      hsbo_next_mode_change_time:
        friendly_name: "HSBO Next Mode Change Time"
        unique_id: hsbo_next_mode_change_time
        value_template: >
          {% set target_hour = states('input_number.hsbo_charge_start_time') | int %}
          {% set now_time = now() %}
          {% set target = now_time.replace(hour=target_hour, minute=0, second=0, microsecond=0) %}
          {% if target <= now_time %}
            {% set target = target + timedelta(days=1) %}
          {% endif %}
          {{ target.strftime('%Y-%m-%d %H:%M:%S') }}

  # Intermediate template sensors
  - platform: template
    sensors:
      hsbo_solar_production:
        friendly_name: "HSBO Solar Production"
        value_template: "{{ states(states('input_text.hsbo_solar_production_power')) | float(0) }}"
        unit_of_measurement: "W"
      hsbo_house_consumption:
        friendly_name: "HSBO House Consumption"
        value_template: "{{ states(states('input_text.hsbo_house_consumption_power')) | float(0) }}"
        unit_of_measurement: "W"

  # Smoothed Solar Production
  - platform: filter
    name: "HSBO Smoothed Solar Production"
    unique_id: hsbo_smoothed_solar_production
    entity_id: sensor.hsbo_solar_production
    filters:
      - filter: lowpass
        time_constant: 10
        precision: 2

  # EMA Solar Production
  - platform: statistics
    name: "HSBO EMA Solar Production"
    unique_id: hsbo_ema_solar_production
    entity_id: sensor.hsbo_smoothed_solar_production
    state_characteristic: mean
    sampling_size: 20
    max_age:
      minutes: 5

  # Smoothed House Load
  - platform: filter
    name: "HSBO Smoothed House Load"
    unique_id: hsbo_smoothed_house_load
    entity_id: sensor.hsbo_house_consumption
    filters:
      - filter: lowpass
        time_constant: 10
        precision: 2

  # EMA House Load
  - platform: statistics
    name: "HSBO EMA House Load"
    unique_id: hsbo_ema_house_load
    entity_id: sensor.hsbo_smoothed_house_load
    state_characteristic: mean
    sampling_size: 20
    max_age:
      minutes: 5

  # Differential EMA Sensor
  - platform: template
    sensors:
      hsbo_differential_ema:
        friendly_name: "HSBO Differential EMA"
        unique_id: hsbo_differential_ema
        value_template: >
          {{ (states('sensor.hsbo_ema_solar_production') | float - 
             states('sensor.hsbo_ema_house_load') | float) | round(2) }}
